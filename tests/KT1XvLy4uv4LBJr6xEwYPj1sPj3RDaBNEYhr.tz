parameter (or unit (map address nat)) ;
storage (pair (map address nat) key_hash) ;
code { DUP ;
       DIP { CDR } ;
       CAR ;
       DUP ;
       IF_LEFT
         { RENAME ;
           DIP { DIP { DUP } ; SWAP } ;
           SWAP ;
           DUP ;
           CAR ;
           PUSH nat 1000 ;
           PUSH mutez 1000000 ;
           AMOUNT ;
           EDIV ;
           IF_NONE { PUSH string "division by 0 impossible" ; FAILWITH } { CAR } ;
           RENAME ;
           MUL ;
           DIP { DUP } ;
           SWAP ;
           SOURCE ;
           GET ;
           IF_NONE
             { DIP { DIP { DUP } ; SWAP } ;
               SWAP ;
               CDR ;
               DIP { DIP { DUP } ; SWAP } ;
               SWAP ;
               DIP { DIP { DUP } ; SWAP } ;
               SWAP ;
               SENDER ;
               DIP { SOME } ;
               UPDATE ;
               PAIR ;
               NIL operation ;
               PAIR }
             { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
               SWAP ;
               CDR ;
               DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
               SWAP ;
               DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
               SWAP ;
               DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
               SWAP ;
               ADD ;
               SENDER ;
               DIP { SOME } ;
               DIP { DIP { DIP { DIP { DROP } } } } ;
               UPDATE ;
               PAIR ;
               NIL operation ;
               PAIR } ;
           DIP { DROP ; DROP ; DROP ; DROP } }
         { RENAME ;
           DIP { DIP { DUP } ; SWAP } ;
           SWAP ;
           DIP { DUP } ;
           SWAP ;
           ITER { RENAME ;
                  DIP { DUP } ;
                  PAIR ;
                  DUP ;
                  DUP ;
                  DUP ;
                  CDR ;
                  DUP ;
                  CAR ;
                  DIP { DIP { DUP } ; SWAP } ;
                  SWAP ;
                  CAR ;
                  DUP ;
                  CAR ;
                  DIP { DIP { DUP } ; SWAP } ;
                  SWAP ;
                  DIP { DUP } ;
                  SWAP ;
                  GET ;
                  IF_NONE
                    { PUSH string "Account provided does not exist." ; FAILWITH }
                    { DIP { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ;
                      SWAP ;
                      CDR ;
                      DIP { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ;
                      SWAP ;
                      DIP { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ;
                      SWAP ;
                      CDR ;
                      DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
                      SWAP ;
                      SUB ;
                      DUP ;
                      ABS ;
                      SWAP ;
                      GE ;
                      IF {} { PUSH string "Credits should not be negative" ; FAILWITH } ;
                      RENAME ;
                      DIP { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ;
                      SWAP ;
                      DIP { SOME } ;
                      DIP { DIP { DIP { DIP { DROP } } } } ;
                      UPDATE ;
                      PAIR } ;
                  DIP { DROP ; DROP ; DROP ; DROP ; DROP ; DROP ; DROP ; DROP } } ;
           DIP { DROP } ;
           RENAME ;
           NIL operation ;
           PAIR } ;
       DIP { DROP ; DROP } }
